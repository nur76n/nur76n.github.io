---
layout: default
title: Ruby on Rails Deploy
nav_order: 80
---

# Ruby on Rails Deploy

Список команд:
```
installing postgres and dependencies
sudo apt-get install -y certbot nginx postgresql nodejs libv8-dev libpq5 libpq-dev

su - postgres
psql
create user ruby_user;
\password ruby_user;
create database ruby_db;
grant all privileges on database ruby_db to ruby_user;

\q

logout
Установка ruby
useradd -s /bin/bash -G sudo -m ruby
echo "ruby ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/92-ruby
chmod 0440 /etc/sudoers.d/92-ruby

su - ruby

gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
\curl -sSL https://get.rvm.io | bash -s stable

logout 
su - ruby 

rvm install ruby-2.7.2

git clone https://github.com/1sherlynn/alphacamp_blog_app.git

cd alphacamp_blog_app

gem install bundler:1.15.4

bundler install

```


```
Добавляем в файл config/database.yml
production:
  <<: *default
  host: localhost
  adapter: postgresql
  encoding: utf8
  database: ruby_db
  pool: 5
  username: ruby_user
  password: password1234

RAILS_ENV=production rake db:migrate

RAILS_ENV=production rake assets:precompile

RAILS_ENV=production rake secret # сохраняем вывод и добавляем в файл systemd puma

mkdir config/puma
```
Содержимое файла /home/ruby/alphacamp_blog_app/config/puma/production.rb

```
rails_env = "production"
environment rails_env

app_dir = "/home/ruby/alphacamp_blog_app" # Update me with your root rails app path

bind  "unix://#{app_dir}/puma.sock"
pidfile "#{app_dir}/puma.pid"
state_path "#{app_dir}/puma.state"
directory "#{app_dir}/"

stdout_redirect "#{app_dir}/log/puma.stdout.log", "#{app_dir}/log/puma.stderr.log", true

workers 1
threads 1,2

activate_control_app "unix://#{app_dir}/pumactl.sock"

prune_bundler
logout
```

### Дальше под рутом

Содержимое файла /etc/systemd/system/puma.service
```
[Unit]
Description=Puma HTTP Server
After=network.target

[Service]
Type=simple
User=ruby
WorkingDirectory=/home/ruby/alphacamp_blog_app
Environment=RAILS_ENV=production
Environment=SECRET_KEY_BASE='5903f4f61848092eca35bdd0255d65eb0eef11b919f82ada12bef0a896e2e252fdf511db3b709b4703feaa82d82488ef3a7779b9283b8cb71662a2531845451e'


ExecStart=/home/ruby/.rvm/gems/ruby-2.7.2/wrappers/puma -C /home/ruby/alphacamp_blog_app/config/puma/production.rb
Restart=always
KillMode=process

[Install]
WantedBy=multi-user.target

```

```
systemctl daemon-reload
systemctl enable puma
systemctl start puma
systemctl status puma
Настройка nginx
systemctl stop nginx
rm /etc/nginx/sites-enabled/default

certbot certonly -n --standalone --agree-tos -m nur76n@mail.ru -d nur76n-ruby.devops.rebrain.srwx.net
```
Содержимое файла /etc/nginx/sites-enabled/ruby
```
upstream app {
  server unix:///home/ruby/alphacamp_blog_app/puma.sock  fail_timeout=0;
}

server {
  listen 80;
  server_name nur76n-ruby.devops.rebrain.srwx.net;

  location / {
    return 301 https://$host$request_uri;
  }
}

server {
  listen 443 ssl;
  server_name  nur76n-ruby.devops.rebrain.srwx.net;
  ssl_certificate /etc/letsencrypt/live/nur76n-ruby.devops.rebrain.srwx.net/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/nur76n-ruby.devops.rebrain.srwx.net/privkey.pem; 

  root /home/ruby/alphacamp_blog_app/public;

  location ^~ /assets/ {
    gzip_static on;
    expires max;
    add_header Cache-Control public;
  }

  location / {
    proxy_pass http://app;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host 'nur76n-ruby.devops.rebrain.srwx.net';
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location ~ ^/(500|404|422).html {
    root /path/to/rails/public;
  }

  error_page 500 502 503 504 /500.html;
  error_page 404 /404.html;
  error_page 422 /422.html;

  client_max_body_size 4G;
  keepalive_timeout 10;
}
```

```
nginx -t
systemctl start nginx
```