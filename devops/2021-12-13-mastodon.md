---
layout: default
title: mastodon Deploy
nav_order: 80
---

# mastodon Deploy

# Установка
---
Список команд, которые были выполнены для достижения результата:
```
curl -sL https://deb.nodesource.com/setup_12.x | bash -


curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list

apt update

apt install -y \
  imagemagick ffmpeg libpq-dev libxml2-dev libxslt1-dev file git-core \
  g++ libprotobuf-dev protobuf-compiler pkg-config nodejs gcc autoconf \
  bison build-essential libssl-dev libyaml-dev libreadline6-dev \
  zlib1g-dev libncurses5-dev libffi-dev libgdbm-dev \
  nginx redis-server redis-tools postgresql postgresql-contrib \
  certbot yarn libidn11-dev libicu-dev libjemalloc-dev

adduser --disabled-login mastodon

su - mastodon

git clone https://github.com/rbenv/rbenv.git ~/.rbenv
cd ~/.rbenv && src/configure && make -C src
echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(rbenv init -)"' >> ~/.bashrc
exec bash
git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build

RUBY_CONFIGURE_OPTS=--with-jemalloc rbenv install 2.7.2
rbenv global 2.7.2

gem install bundler --no-document

exit
```


```
sudo fallocate -l 1G /swapfile
sudo dd if=/dev/zero of=/swapfile bs=1024 count=1048576
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

```
sudo -u postgres psql


CREATE USER mastodon CREATEDB;
\q


su - mastodon

git clone https://github.com/mastodon/mastodon.git live && cd live
git checkout $(git tag -l | grep -v 'rc[0-9]*$' | sort -V | tail -n 1)

bundle config deployment 'true'
bundle config without 'development test'
bundle install -j$(getconf _NPROCESSORS_ONLN)
yarn install --pure-lockfile

RAILS_ENV=production bundle exec rake mastodon:setup
# admin login nur76n@mail.ru pwd 2072ab1317011d0d26e753a0c742414b

exit

```

```
cp /home/mastodon/live/dist/nginx.conf /etc/nginx/sites-available/mastodon
ln -s /etc/nginx/sites-available/mastodon /etc/nginx/sites-enabled/mastodon
sed -i 's/example.com/nur76n-dev.devops.rebrain.srwx.net/g' /etc/nginx/sites-enabled/mastodon
## and uncomment ssl_certificate and ssl_certificate_key options

systemctl stop nginx

rm /etc/nginx/sites-enabled/default

certbot certonly -n --standalone --agree-tos -m nur76n@mail.ru -d nur76n-dev.devops.rebrain.srwx.net

systemctl start nginx

cp /home/mastodon/live/dist/mastodon-*.service /etc/systemd/system/

# nano /etc/systemd/system/mastodon-*.service

systemctl daemon-reload

systemctl enable --now mastodon-web mastodon-sidekiq mastodon-streaming

```